flowchart TD
  subgraph MLOPS[MLOps]
    direction TB
    BL["Back-Labeler\nOn trade close → realised R, run-up, draw-down\nAppend labels.parquet (DVC) → S3"]:::ops
    TR["Train-Runner (nightly CI)\nPull DVC datasets; train CNN + LGBM; compare vs prod; upload to S3"]:::ops
    MW["Model-Watcher (sidecar)\nS3 sync 15m; SIGUSR1 hot-reload; log semver"]:::ops
  end
  TS["TimescaleDB\ntrades"]:::db
  S3["S3/B2\nmodels + datasets"]:::storage

  TS --> BL
  BL -->|"labels.parquet (DVC push)"| S3
  S3 --> TR
  TR -->|"*.onnx + metrics.json"| S3
  S3 --> MW

classDef svc fill:#0ea5e9,stroke:#0369a1,stroke-width:2px,color:#ffffff;
classDef model fill:#22c55e,stroke:#15803d,stroke-width:2px,color:#ffffff;
classDef db fill:#f59e0b,stroke:#b45309,stroke-width:2px,color:#111111;
classDef bus fill:#f43f5e,stroke:#be123c,stroke-width:2px,color:#ffffff;
classDef cache fill:#a78bfa,stroke:#7c3aed,stroke-width:2px,color:#ffffff;
classDef storage fill:#f97316,stroke:#9a3412,stroke-width:2px,color:#111111;
classDef api fill:#64748b,stroke:#334155,stroke-width:2px,color:#ffffff;
classDef overlay fill:#14b8a6,stroke:#0f766e,stroke-width:2px,color:#ffffff;
classDef ops fill:#94a3b8,stroke:#475569,stroke-width:2px,color:#111111;
classDef user fill:#e2e8f0,stroke:#64748b,stroke-width:2px,color:#111111;
linkStyle default stroke-width:1.6px

