flowchart TD
  subgraph REG[Registry & Macro]
    direction TB
    SR["Symbol-Registry (nightly)\nInputs: Binance/OKX exchangeInfo, spreads; CoinGecko caps; banlist\nCompute: data_health 0..100; status ACTIVE/PROBATION/EXCLUDED/OVERRIDE; liquidity_cluster H/M/L\nWrites: Timescale coin_registry\nEmits: symbol_events.updated"]:::svc
    MOC["Macro On-Chain Ingestor (15m + daily)\nInputs: BTC/ETH/SOL exchange_netflow; BTC exchange_reserve%; ETH gas; USDT+USDC CEX netflow\nDaily: BTC MVRV, aSOPR(7d), NUPL\nWrites: macro_onchain_15m, macro_btc_daily\nEmits: onchain.macro.15m (opt)"]:::svc
  end
  TS["TimescaleDB\ncoin_registry,\nmacro_onchain_15m,\nmacro_btc_daily"]:::db
  RMQ["RabbitMQ\ntopic: trading.bus"]:::bus

  SR -->|"upsert coin_registry"| TS
  SR -->|"symbol_events.updated"| RMQ
  MOC -->|"upsert macro rows"| TS
  MOC -->|"onchain.macro.15m (opt)"| RMQ

classDef svc fill:#0ea5e9,stroke:#0369a1,stroke-width:2px,color:#ffffff;
classDef model fill:#22c55e,stroke:#15803d,stroke-width:2px,color:#ffffff;
classDef db fill:#f59e0b,stroke:#b45309,stroke-width:2px,color:#111111;
classDef bus fill:#f43f5e,stroke:#be123c,stroke-width:2px,color:#ffffff;
classDef cache fill:#a78bfa,stroke:#7c3aed,stroke-width:2px,color:#ffffff;
classDef storage fill:#f97316,stroke:#9a3412,stroke-width:2px,color:#111111;
classDef api fill:#64748b,stroke:#334155,stroke-width:2px,color:#ffffff;
classDef overlay fill:#14b8a6,stroke:#0f766e,stroke-width:2px,color:#ffffff;
classDef ops fill:#94a3b8,stroke:#475569,stroke-width:2px,color:#111111;
classDef user fill:#e2e8f0,stroke:#64748b,stroke-width:2px,color:#111111;
linkStyle default stroke-width:1.6px

