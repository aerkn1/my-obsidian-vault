flowchart TD
  subgraph FEAT[Feature & Pattern]
    direction TB
    FE["Feature-Engine (per bar)\nPulls: barXX (CAs), metric_15s, lob_1s, macro_onchain_15m, macro_btc_daily, coin_registry, bias topics\nComputes: 68+ features (ATR_z, RSI zone/mom/div, EMA ratios, daily bands, cvd/oi z, absorption, spoof_ratio,\nheat_bias, funding_prem_z, basis_z, rel_z_btc/eth, bias_4h/conf, macro indices, BTC regime)\nWrites: Redis vec:SYMBOL:TF\nEmits: feats_ready.SYMBOL.TF"]:::svc
    PC["Pattern-Classifier (CNN→ONNX)\nInput: 64×64×3 image\nOutput: pattern, quality, pole_kATR, 64-d embed"]:::model
    SIM["Similarity-API (pgvector)\nInput: 64-d embed\nOutput: sim_conf, hist_rr_pct"]:::model
  end
  RD["Redis\nvec:SYMBOL:TF"]:::cache
  TS["TimescaleDB\nCA bars, metrics, macro"]:::db
  RMQ["RabbitMQ\ntrading.bus"]:::bus

  TS --> FE
  FE -->|"set vec:SYMBOL:TF"| RD
  FE -->|"feats_ready.SYMBOL.TF"| RMQ

classDef svc fill:#0ea5e9,stroke:#0369a1,stroke-width:2px,color:#ffffff;
classDef model fill:#22c55e,stroke:#15803d,stroke-width:2px,color:#ffffff;
classDef db fill:#f59e0b,stroke:#b45309,stroke-width:2px,color:#111111;
classDef bus fill:#f43f5e,stroke:#be123c,stroke-width:2px,color:#ffffff;
classDef cache fill:#a78bfa,stroke:#7c3aed,stroke-width:2px,color:#ffffff;
classDef storage fill:#f97316,stroke:#9a3412,stroke-width:2px,color:#111111;
classDef api fill:#64748b,stroke:#334155,stroke-width:2px,color:#ffffff;
classDef overlay fill:#14b8a6,stroke:#0f766e,stroke-width:2px,color:#ffffff;
classDef ops fill:#94a3b8,stroke:#475569,stroke-width:2px,color:#111111;
classDef user fill:#e2e8f0,stroke:#64748b,stroke-width:2px,color:#111111;
linkStyle default stroke-width:1.6px

