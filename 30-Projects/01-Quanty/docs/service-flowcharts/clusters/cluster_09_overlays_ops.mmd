flowchart TD
  subgraph OVLY[Overlays & Ops]
    direction TB
    HRP["HRP Overlay (daily)\nCompute cluster budgets; publish hrp:budget"]:::overlay
    CVAR["CVaR Guard\nEstimate CVaRÎ± per sym/tf; publish cvar:SYMBOL:TF"]:::overlay
    OBS["Observability\nProm/Grafana/Loki/Tempo\nSLIs: latency, win rate, missing, drift PSI"]:::ops
    RET["Retention & Gating\nSubscribe/unsubscribe heavy feeds; purge after 90d (archive S3)"]:::ops
  end
  TS["TimescaleDB"]:::db
  RD["Redis"]:::cache
  S3["S3 Archive"]:::storage
  RMQ["RabbitMQ\ntrading.bus"]:::bus

  TS --> HRP
  HRP -->|"hrp:budget / hrp.update.daily"| RMQ
  TS --> CVAR
  CVAR -->|"cvar:SYMBOL:TF / cvar.update"| RMQ
  RET -->|"control.subscribe/unsubscribe"| RMQ
  RET -->|"archives"| S3
  OBS -- tap --> RMQ
  OBS -- tap --> TS

classDef svc fill:#0ea5e9,stroke:#0369a1,stroke-width:2px,color:#ffffff;
classDef model fill:#22c55e,stroke:#15803d,stroke-width:2px,color:#ffffff;
classDef db fill:#f59e0b,stroke:#b45309,stroke-width:2px,color:#111111;
classDef bus fill:#f43f5e,stroke:#be123c,stroke-width:2px,color:#ffffff;
classDef cache fill:#a78bfa,stroke:#7c3aed,stroke-width:2px,color:#ffffff;
classDef storage fill:#f97316,stroke:#9a3412,stroke-width:2px,color:#111111;
classDef api fill:#64748b,stroke:#334155,stroke-width:2px,color:#ffffff;
classDef overlay fill:#14b8a6,stroke:#0f766e,stroke-width:2px,color:#ffffff;
classDef ops fill:#94a3b8,stroke:#475569,stroke-width:2px,color:#111111;
classDef user fill:#e2e8f0,stroke:#64748b,stroke-width:2px,color:#111111;
linkStyle default stroke-width:1.6px

