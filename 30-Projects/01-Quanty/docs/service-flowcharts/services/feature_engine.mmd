flowchart TD
RMQ["RabbitMQ\ntrading.bus"]:::bus
TS["TimescaleDB"]:::db
RD["Redis Cluster\nvec:SYMBOL:TF"]:::cache
SVC["Feature-Engine (per bar)"]:::svc
IN1["TS: bar15m/1h/4h/1d (CA), metric_15s, lob_1s"]:::api
IN1 --> SVC
IN2["TS: macro_onchain_15m, macro_btc_daily"]:::api
IN2 --> SVC
IN3["RMQ: price_updates, metric_updates, lob.snap"]:::api
IN3 --> SVC
IN4["Registry/bias topics"]:::api
IN4 --> SVC
ST1["Join & resample inputs to TF window"]:::svc
SVC --> ST1
ST1 --> SVC
ST2["Compute 68+ features (vol, momentum, flow, LOB, derivatives)"]:::svc
SVC --> ST2
ST2 --> SVC
ST3["Daily bands (median±σ for dips/peaks/true-range)"]:::svc
SVC --> ST3
ST3 --> SVC
ST4["Cross-pair & higher-TF bias (provisional/confirmed)"]:::svc
SVC --> ST4
ST4 --> SVC
ST5["Macro indices & BTC regime features"]:::svc
SVC --> ST5
ST5 --> SVC
ST6["Pack float32[]; write Redis vec:SYMBOL:TF"]:::svc
SVC --> ST6
ST6 --> SVC
ST7["Emit feats_ready.SYMBOL.TF"]:::svc
SVC --> ST7
ST7 --> SVC
OUT1["Redis: vec:SYMBOL:TF"]:::api
SVC --> OUT1
OUT2["RabbitMQ: feats_ready.SYMBOL.TF"]:::api
SVC --> OUT2

classDef svc fill:#0ea5e9,stroke:#0369a1,stroke-width:2px,color:#ffffff;
classDef model fill:#22c55e,stroke:#15803d,stroke-width:2px,color:#ffffff;
classDef db fill:#f59e0b,stroke:#b45309,stroke-width:2px,color:#111111;
classDef bus fill:#f43f5e,stroke:#be123c,stroke-width:2px,color:#ffffff;
classDef cache fill:#a78bfa,stroke:#7c3aed,stroke-width:2px,color:#ffffff;
classDef storage fill:#f97316,stroke:#9a3412,stroke-width:2px,color:#111111;
classDef api fill:#64748b,stroke:#334155,stroke-width:2px,color:#ffffff;
classDef overlay fill:#14b8a6,stroke:#0f766e,stroke-width:2px,color:#ffffff;
classDef ops fill:#94a3b8,stroke:#475569,stroke-width:2px,color:#111111;
classDef user fill:#e2e8f0,stroke:#64748b,stroke-width:2px,color:#111111;
linkStyle default stroke-width:1.6px
