name: Daily Branch Sync to Main

on:
  schedule:
    # Run at 11:59 PM every day (23:59 UTC)
    - cron: '59 23 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  sync-daily-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Get today's date
      id: date
      run: echo "TODAY=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
    
    - name: Check if today's branch exists
      id: check-branch
      run: |
        BRANCH_NAME="obsidian-${{ steps.date.outputs.TODAY }}"
        if git ls-remote --heads origin | grep -q "refs/heads/$BRANCH_NAME"; then
          echo "EXISTS=true" >> $GITHUB_OUTPUT
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Today's branch $BRANCH_NAME exists"
        else
          echo "EXISTS=false" >> $GITHUB_OUTPUT
          echo "Today's branch $BRANCH_NAME does not exist"
        fi
    
    - name: Sync daily branch to main
      if: steps.check-branch.outputs.EXISTS == 'true'
      run: |
        BRANCH_NAME="${{ steps.check-branch.outputs.BRANCH_NAME }}"
        echo "Syncing $BRANCH_NAME to main..."
        
        # Checkout main branch
        git checkout main
        git pull origin main
        
        # Merge today's branch into main
        git merge "origin/$BRANCH_NAME" --no-ff -m "Daily sync: Merge $BRANCH_NAME into main"
        
        # Push the updated main branch
        git push origin main
        
        echo "Successfully synced $BRANCH_NAME to main"
    
    - name: Create summary
      run: |
        if [[ "${{ steps.check-branch.outputs.EXISTS }}" == "true" ]]; then
          echo "✅ Daily branch ${{ steps.check-branch.outputs.BRANCH_NAME }} successfully synced to main" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No daily branch found for today (${{ steps.date.outputs.TODAY }})" >> $GITHUB_STEP_SUMMARY
        fi

  cleanup-old-branches:
    runs-on: ubuntu-latest
    needs: sync-daily-branch
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Clean up old daily branches
      run: |
        echo "Cleaning up daily branches older than 7 days..."
        
        # Get current date in seconds since epoch
        CURRENT_DATE=$(date +%s)
        SEVEN_DAYS_AGO=$((CURRENT_DATE - 7*24*60*60))
        
        # Get all remote obsidian-* branches
        for branch in $(git ls-remote --heads origin | grep 'obsidian-[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' | sed 's/.*refs\/heads\///'); do
          # Extract date from branch name (obsidian-YYYY-MM-DD)
          BRANCH_DATE=$(echo "$branch" | sed 's/obsidian-//')
          
          # Convert branch date to seconds since epoch
          BRANCH_DATE_SECONDS=$(date -d "$BRANCH_DATE" +%s 2>/dev/null || echo "0")
          
          # If branch is older than 7 days, delete it
          if [[ $BRANCH_DATE_SECONDS -lt $SEVEN_DAYS_AGO && $BRANCH_DATE_SECONDS -gt 0 ]]; then
            echo "Deleting old branch: $branch (date: $BRANCH_DATE)"
            git push origin --delete "$branch"
          else
            echo "Keeping branch: $branch (date: $BRANCH_DATE)"
          fi
        done
        
        echo "Cleanup completed"
